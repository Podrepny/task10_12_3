#cloud-config
password: qwerty
chpasswd: { expire: False }
ssh_authorized_keys:
  - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQC/IeMDV6AvuzljMhg6KQ+LS+R6949CacQJEGzMUWh4sKeDlhjvXda1fSDVFjvBZBwW9JoLjF8Y/Ji7bDkW8406XGoer/euojyyIGqvBMNEhZITrb1Gc7o5jet9fhsbY3A4lirSB68PPwW+EySlKchnV1nqVRUFZyfEn0C75uxLCiEDgEEy9U3x2OZIoUYcYD5xHs7zP1KfmqpDVVgsqnYRTnFePz2/ymHF6GLsvYva9zJGipnrkDXmwREO8tnONPV/RCzqwk1Mj1WaVCQpHKL6140+B8aO2hcxCZGnbWHr+QavBmEhVt0RgzgfTmon0WjJSpS8swocLIJbKfxYWwmK9U3vf4hrcrl1gqVdJtB4f8PwdQffyJhLsfaDQksoSnRbYJ5EaNXEYu+VhYbdx7MCYu1HcWfiQyD4I8AIu7cQrQmyfF00uoUSxRDeRRpErXELJLi0rJQF8mQqO9UMU+yUzrX2ts86yyfrOpFmbyaX1qGHsjoJOtuqsB41i4rvxgoC0sE/p9VrnivnUd0UzMRYKUF1O7isvKwFO/SW3fxkKS+UJYFm4KU/nvcyhkD6PEa48FG6ZuCdn/4j2K8KKfLzASyl1/8Xi6bQjAVZSdMFdfHDinjn6YY/QEdyVUPrHdacyXExQut9hX371ZBkY0ee/inG/sqZrHCGIGqPG7GVuw== alexey@ubuntu-server-16

runcmd:
 - [ sh, -c, "/sbin/sysctl net.ipv4.ip_forward=1" ]
 - [ sh, -c, "/sbin/iptables -t nat -A POSTROUTING -s 192.168.124.102 -o ens3 -j MASQUERADE" ]
 - [ sh, -c, "/sbin/ip link add vxlan0 type vxlan id 12345 remote 192.168.124.102 local 192.168.124.101 dstport 4789" ]
 - [ sh, -c, "/sbin/ip link set vxlan0 up" ]
 - [ sh, -c, "/sbin/ip addr add 10.255.0.101/24 dev vxlan0" ]
 - [ sh, -c, "/usr/bin/curl -fsSL https://download.docker.com/linux/ubuntu/gpg | /usr/bin/apt-key add -" ]
 - [ sh, -c, '/usr/bin/add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu xenial stable"' ]
 - [ sh, -c, "/usr/bin/apt-get update" ]
 - [ sh, -c, "/usr/bin/apt-get -y install docker-ce docker-compose bridge-utils" ]
 - [ sh, -c, "mkdir -p /root/.ssh" ]
 - [ sh, -c, "cat /home/ubuntu/.ssh/authorized_keys > /root/.ssh/authorized_keys" ]
 - [ sh, -c, "chmod 600 /root/.ssh/authorized_keys" ]
# - [ sh, -c, "/bin/mount -o ro /dev/sr0 /media" ]
# - [ sh, -c, "/bin/mkdir -p /srv/certs /srv/nginx /srv/docker-compose" ]
# - [ sh, -c, "/bin/mkdir -p /srv/log/nginx" ]
# - [ sh, -c, "/bin/cp -fr /media/certs/* /srv/certs" ]
# - [ sh, -c, "/bin/cp -f /media/etc/nginx.conf /srv/nginx/" ]
# - [ sh, -c, "/bin/cp -f /media/docker-compose.yml /srv/docker-compose/" ]
# - [ sh, -c, "/bin/umount /media" ]
# - [ sh, -c, "/bin/echo OOKK" ]
# - [ sh, -c, "cd /srv/docker-compose ; /bin/pwd ; /usr/bin/docker-compose --verbose up -d" ]
# - [ sh, -c, "/usr/bin/docker-compose --verbose up -d" ]
# - [ sh, -c, "/bin/sleep 25" ]
# - [ sh, -c, "CNT=0; while :; do /usr/bin/docker-compose ps | /bin/grep Up > /dev/null ; if [ 0 -eq \"0\" ]; then /bin/echo Yes ; if [ \"\" -ge \"240\" ]; then /bin/echo \"TIMEOUT\" ; break; fi ; else /bin/echo NO ; break ; fi ; /bin/sleep 0.5 ; ((CNT++)) ; /bin/echo \"CNT: \" ; done" ]
# - [ sh, -c, "/bin/sleep 5 ; /usr/bin/docker ps ; /bin/date" ]
